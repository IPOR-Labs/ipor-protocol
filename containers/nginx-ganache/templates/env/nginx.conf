worker_processes                            5;

events {
    worker_connections                      1024;
}

http {

    server_tokens                           off;

    server {
        listen                              34555 ssl http2;
        listen                              [::]:34555 ssl http2;

        server_name                         {{ domain }} www.{{ domain }};

        error_page                          401 /error_docs/401/401.html;
        error_page                          404 /error_docs/404/404.html;
        error_page                          500 502 503 504 /error_docs/50x/50x.html;

        ssl_certificate                     /etc/nginx/cert/tls.crt;
        ssl_certificate_key                 /etc/nginx/cert/tls.key;

        ssl_session_cache                   shared:NginxCache123:50m;
        ssl_session_timeout                 5m;

        ssl_prefer_server_ciphers           on;

        ssl_ciphers                         'ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS';

        ssl_dhparam                         /etc/nginx/cert/dhparam.pem;

        ssl_protocols                       TLSv1 TLSv1.1 TLSv1.2;

        ssl_stapling                        on;
        ssl_stapling_verify                 on;
        ssl_trusted_certificate             /etc/nginx/cert/fullchain.cer;
        resolver                            8.8.8.8 valid=300s ipv6=off;
        resolver_timeout                    5s;

        proxy_pass_header                   Server;

        #add_header                         Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        #add_header                         Strict-Transport-Security "max-age=31536000" always;
        add_header                          Strict-Transport-Security "max-age=31536000; includeSubDomains";

        access_log                          /var/log/nginx/access.log;
        error_log                           /var/log/nginx/error.log debug;

        ####################################
        # LOCATIONS
        ####################################


        # DEFAULT
        location /reset-sc {

            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, HEAD, DELETE, PUT, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-CustomHeader';
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, HEAD, DELETE, PUT, PATCH';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-CustomHeader';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            auth_basic                          "Restricted Access";
            auth_basic_user_file                /etc/nginx/htpasswd.users;

            add_header 'Content-Type' 'text/plain; charset=utf-8';

            content_by_lua_block {

                local shell = require "resty.shell"

                local stdin = "hello"
                local timeout = 120000
                local max_size = 1048576

                local ok, stdout, stderr, reason, status = shell.run("ssh -o StrictHostKeyChecking=accept-new -l ubuntu -i /etc/nginx/keys/ipor-warren.pem host.docker.internal '. /home/ubuntu/.bash_profile && cd /home/ubuntu/repos/ipor-protocol && . /home/ubuntu/repos/ipor-protocol/run.sh m p'", stdin, timeout, max_size)

                ngx.say('ok ', ok)
                ngx.say('stdout ', stdout)
                ngx.say('stderr ', stderr)
                ngx.say('reason ', reason)
                ngx.say('status ', status)
            }

        }

        # DEFAULT
        location / {

            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, HEAD, DELETE, PUT, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-CustomHeader';
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, HEAD, DELETE, PUT, PATCH';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-CustomHeader';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            auth_basic                          "Restricted Access";
            auth_basic_user_file                /etc/nginx/htpasswd.users;

            proxy_pass                          http://ipor-protocol-ganache:8545;
            proxy_redirect                      off;
            proxy_buffering                     off;

            proxy_http_version                  1.1;
            proxy_set_header Connection         "Keep-Alive";
            proxy_set_header Proxy-Connection   "Keep-Alive";

            include                             /etc/nginx/nginx.api-proxy.conf;
        }

        location /error_docs {
            alias                               /usr/share/nginx/html/errors/;
            log_not_found                       off;
            access_log                          off;
        }
    }

}
