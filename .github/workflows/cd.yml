name: CD

on:
    push:
        branches:
            - main
            - develop

jobs:
    notify:
        uses: ./.github/workflows/notify-slack.yml
        secrets:
            SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    build-sc:
        needs: notify
        uses: ./.github/workflows/build-smart-contracts.yml
        secrets:
            PROVIDER_URL: ${{ secrets.PROVIDER_URL }}
        with:
            compile-command: 'compile:hardhat'

    foundry-tests:
        needs: notify
        uses: ./.github/workflows/foundry-tests.yml
        secrets:
            FORK_URL: ${{ secrets.PROVIDER_URL }}
        with:
            test-options: '--no-match-path "test/fork/*"'
            fork-test-options: '--match-path "test/fork/*"'

    build-java:
        needs: notify
        uses: ./.github/workflows/build-java.yml
        with:
            solc-version: 0.8.16
            smart-contracts-compile-enabled: true
            build-enabled: true
            tests-enabled: true
            publish-jar-enabled: false
            push-docker-enabled: false

    trigger-containers:
        needs: notify
        runs-on: ubuntu-latest
        steps:

            - name: Trigger build containers
              # from tag: v1.6.5
              uses: convictional/trigger-workflow-and-wait@f69fa9eedd3c62a599220f4d5745230e237904be
              with:
                  owner: IPOR-Labs
                  repo: ${{ secrets.BUILD_CONTAINERS_REPO }}
                  github_token: ${{ secrets.TOKEN_RUN_BUILD_CONTAINERS }}
                  workflow_file_name: cd.yml
                  ref: main
                  client_payload: >-
                      {
                      "src-sha": "${{ github.sha }}",
                      "src-actor": "${{ github.triggering_actor }}",
                      "src-repository": "${{ github.repository }}",
                      "src-workflow": "${{ github.workflow }}",
                      "src-run-url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}"
                      }
                  wait_interval: 0
                  propagate_failure: false
                  trigger_workflow: true
                  wait_workflow: false

    publish-jar:
        if: ${{ needs.notify.outputs.branch-name == 'main' }}
        needs:
            - notify
            - build-sc
            - foundry-tests
            - build-java
            - trigger-containers
        uses: ./.github/workflows/build-java.yml
        with:
            smart-contracts-compile-enabled: true
            build-enabled: true
            tests-enabled: false
            publish-jar-enabled: true
            push-docker-enabled: false

    report:
        if: ${{ always() }}
        needs:
            - notify
            - build-sc
            - foundry-tests
            - build-java
            - trigger-containers
            - publish-jar
        uses: ./.github/workflows/report-slack.yml
        secrets:
            SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        with:
            success: ${{ needs.build-sc.result == 'success' && needs.foundry-tests.result == 'success' && needs.build-java.result == 'success' && needs.trigger-containers.result == 'success' && (needs.publish-jar.result == 'success' || needs.publish-jar.result == 'skipped') }}
            slack-status-msg-id: ${{ needs.notify.outputs.slack-status-msg-id }}
